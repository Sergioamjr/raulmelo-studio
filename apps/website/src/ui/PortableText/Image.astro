---
import { Picture } from '@astrojs/image/components';
import { imgUrlFor } from '@raulmelo/core/utils';

import { sanityClient } from '@/infrastructure/sanity/client';
import {
  calculateAspectRatio,
  scaleDownImageSize,
} from '@/infrastructure/utils/image';

type Props = {
  node: {
    caption: string;
    image: {
      url: string;
      width: number;
      height: number;
    };
  };
};

const {
  node: { image, caption },
} = Astro.props;

const nextImage = imgUrlFor(sanityClient, image.url);
const nextImageSize = scaleDownImageSize(image.width, image.height);
const aspectRatio = calculateAspectRatio(
  nextImageSize.width,
  nextImageSize.height,
);

const maxWidth = nextImageSize.width;

const isGif = image.url.endsWith(`.gif`);
---

{
  isGif ? (
    <img
      src={nextImage.url()}
      width={nextImageSize.width}
      height={nextImageSize.height}
    />
  ) : (
    <Picture
      class="object-cover mx-auto"
      src={nextImage.url()}
      aspectRatio={aspectRatio}
      widths={[200, 400, 640, 768, maxWidth]}
      sizes={`(max-width: ${maxWidth}px) 100vw, ${maxWidth}px`}
      alt={caption}
      width={nextImageSize.width}
      height={nextImageSize.height}
    />
  )
}
