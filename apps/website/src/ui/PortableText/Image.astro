---
import { Picture } from '@astrojs/image/components';
import { imgUrlFor } from '@raulmelo/core/utils';

import { sanityClient } from '@/infrastructure/sanity/client';

type Props = {
  node: {
    caption: string;
    customWidth?: number;
    image: {
      url: string;
      width: number;
      height: number;
    };
  };
};

const {
  node: { image, caption, customWidth },
} = Astro.props;

const { url, width, height, aspectRatio } = imgUrlFor(sanityClient, image);

const finalWidth = customWidth || width;
const finalHeight = customWidth
  ? calculateCustomHeight(height, width, finalWidth)
  : height;

/**
 * Sharp + vercel edge functions are throwing an error when trying to resize
 * gifs.
 *
 * This is attempt to fix it.
 */
const isGif = image.url.endsWith(`.gif`);
const isLarge = finalWidth > 768;

function calculateCustomHeight(
  height: number,
  width: number,
  customWidth: number,
): number {
  const aspectRatio = height / width;
  const customHeight = aspectRatio * customWidth;
  return customHeight;
}
---

{
  isGif && isLarge ? (
    <img src={url} alt={caption} loading="lazy" />
  ) : (
    <Picture
      class="object-cover mx-auto"
      src={url}
      aspectRatio={aspectRatio}
      widths={[200, 400, 640, 768, finalWidth]}
      sizes={`(max-width: ${finalWidth}px) 100vw, ${finalWidth}px`}
      alt={caption}
      width={finalWidth}
      height={finalHeight}
    />
  )
}
