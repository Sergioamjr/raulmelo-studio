---
import {
  getImageDimensionsFromSanityImageUrl,
  imgUrlFor,
  isEmpty,
  isNil,
} from '@raulmelo/core/utils';
import { ImageSlider } from '@raulmelo/ui';

import { sanityClient } from '@/infrastructure/sanity/client';
import { scaleDownImageSize } from '@/infrastructure/utils/image';

type ImageNode = {
  alt: string;
  caption: string;
  image: {
    _type: 'image';
    asset: {
      _ref: string;
      _type: 'reference';
    };
  };
};

type Props = {
  node: {
    images: ImageNode[];
  };
};

const { images } = Astro.props.node;

const isImageEmpty = isNil(images) || isEmpty(images);

const adaptedImages = images.map((img) => {
  const { alt, caption, image } = img;

  const src = imgUrlFor(sanityClient, image).url();

  const imgDimensions = getImageDimensionsFromSanityImageUrl(src);
  const { height, width } = scaleDownImageSize(
    imgDimensions.width,
    imgDimensions.height,
  );

  return {
    alt,
    caption,
    height,
    width,
    src: `${src}?fit=crop&auto=format`,
  };
});
---

{isImageEmpty ? null : <ImageSlider images={adaptedImages} client:visible />}
